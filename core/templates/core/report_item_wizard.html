{% extends 'core/base.html' %}

{% block content %}
<div class="min-h-screen bg-[#fafafa] pb-20 transition-colors duration-300">
    <div class="max-w-6xl mx-auto px-4 pt-10">
        
        {% include 'core/includes/messages.html' %}

        <div class="row g-5">
            {# --- LEFT COLUMN: THE NEO-BRUTALIST FORM --- #}
            <div class="col-lg-7">
                <div class="bg-white border-4 border-black shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] overflow-hidden">
                    
                    <div class="bg-indigo-600 p-6 border-b-4 border-black text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h2 class="text-3xl font-black uppercase italic tracking-tighter mb-0">Initialize Broadcast</h2>
                                <p class="text-indigo-200 text-xs mt-1 font-black uppercase tracking-[0.2em]">
                                    Node Sync: Step {{ step }} / 2
                                </p>
                            </div>
                            <div id="status-icon" class="w-14 h-14 bg-black flex items-center justify-center shadow-[4px_4px_0px_0px_rgba(255,255,255,1)]">
                                <i class="fa-solid fa-bolt text-2xl text-yellow-400"></i>
                            </div>
                        </div>
                    </div>

                    <div class="card-body p-6 p-md-10">
                        {# --- STEP TITLE --- #}
                        <div class="mb-8 border-l-8 border-indigo-600 pl-4">
                            <h3 class="text-2xl font-black text-black uppercase mb-1">
                                {% if step == '1' %}01. Core Identity{% else %}02. Visual & Metadata{% endif %}
                            </h3>
                            <p class="text-slate-500 font-bold text-sm uppercase italic">
                                {% if step == '1' %}Define the nature of the signal.{% else %}Inject descriptive data into the stream.{% endif %}
                            </p>
                        </div>

                        <form method="POST" enctype="multipart/form-data" novalidate id="wizardForm" class="space-y-6">
                            {% csrf_token %}

                            {% for field in form %}
                                <div class="form-group-container mb-6">
                                    <label for="{{ field.id_for_label }}" class="block text-xs font-black text-black uppercase tracking-widest mb-2">
                                        // {{ field.label }}
                                        {% if field.field.required %}<span class="text-indigo-600">*</span>{% endif %}
                                    </label>

                                    <div class="field-wrapper">
                                        {{ field }}
                                    </div>

                                    {% for error in field.errors %}
                                        <div class="bg-red-500 text-white font-black text-[10px] uppercase mt-2 px-2 py-1 inline-block shadow-[2px_2px_0px_0px_rgba(0,0,0,1)]">
                                            <i class="fas fa-times-circle me-1"></i>{{ error }}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% endfor %}

                            <div class="d-flex justify-content-between align-items-center mt-10 pt-8 border-t-4 border-black border-dashed">
                                {% if step == '2' %}
                                    <a href="?step=1" class="bg-white border-4 border-black px-6 py-2 font-black uppercase tracking-widest hover:bg-slate-100 transition-all shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] active:translate-x-1 active:translate-y-1 active:shadow-none">
                                        Back
                                    </a>
                                {% else %}
                                    <a href="{% url 'core:home' %}" class="font-black text-xs uppercase text-slate-400 hover:text-black transition-colors tracking-widest">Abort Task</a>
                                {% endif %}

                                <button type="submit" id="submitBtn" class="bg-indigo-600 text-white border-4 border-black px-8 py-3 font-black uppercase tracking-widest shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] hover:shadow-[6px_6px_0px_0px_rgba(0,0,0,1)] transition-all active:translate-x-1 active:translate-y-1 active:shadow-none">
                                    {% if step == '2' %}
                                        Finalize Broadcast
                                    {% else %}
                                        Next Node â†’
                                    {% endif %}
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            {# --- RIGHT COLUMN: THE PREVIEW CARD --- #}
            <div class="col-lg-5">
                <div class="sticky-top" style="top: 8rem;">
                    <h5 class="mb-4 font-black text-black uppercase tracking-widest text-sm flex items-center gap-2">
                        <span class="w-3 h-3 bg-indigo-600 shadow-[2px_2px_0px_0px_rgba(0,0,0,1)] animate-pulse"></span>
                        Live Record Preview
                    </h5>
                    
                    <div id="preview-container" class="bg-white border-4 border-black shadow-[10px_10px_0px_0px_rgba(79,70,229,1)] overflow-hidden transition-all duration-500">
                        <div class="relative border-b-4 border-black">
                            <img id="prev-img" src="https://via.placeholder.com/400x300?text=AWAITING+VISUALS" alt="Preview" class="w-full h-64 object-cover grayscale hover:grayscale-0 transition-all">
                            <span id="prev-badge" class="absolute top-4 left-4 bg-yellow-400 border-2 border-black px-4 py-1 font-black text-[10px] uppercase shadow-[3px_3px_0px_0px_rgba(0,0,0,1)]">PENDING_TYPE</span>
                        </div>
                        <div class="p-6 bg-white">
                            <h5 id="prev-title" class="font-black text-2xl uppercase italic leading-none mb-4 text-black">Untitled_Item</h5>
                            <p id="prev-desc" class="text-slate-600 font-bold text-sm leading-tight mb-6 line-clamp-3">
                                Input stream required for description generation...
                            </p>
                            
                            <div class="space-y-2 mb-6">
                                <div class="flex justify-between border-b-2 border-black border-dotted pb-1">
                                    <span class="font-black text-[9px] uppercase text-slate-400">Location_Node</span>
                                    <span id="prev-loc" class="font-black text-[9px] uppercase text-black">Undefined</span>
                                </div>
                                <div class="flex justify-between border-b-2 border-black border-dotted pb-1">
                                    <span class="font-black text-[9px] uppercase text-slate-400">Temporal_Marker</span>
                                    <span id="prev-date" class="font-black text-[9px] uppercase text-black">Not_Set</span>
                                </div>
                            </div>

                            <div class="pt-4 border-t-4 border-black flex justify-between items-center bg-slate-50 -mx-6 px-6 py-4 -mb-6">
                                <span class="font-black text-[10px] uppercase text-indigo-600">
                                    <i class="fa-solid fa-satellite-dish mr-2 animate-bounce"></i>Status: Active_Sync
                                </span>
                                <span class="font-black text-[10px] uppercase text-slate-400 italic">v1.0.4_stable</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Neo-Brutalist Form Controls Override */
    #wizardForm input:not([type="file"]):not([type="radio"]), 
    #wizardForm select, 
    #wizardForm textarea {
        width: 100%;
        padding: 1rem;
        border: 4px solid black !important;
        border-radius: 0px !important;
        background-color: white;
        color: black;
        font-weight: 900;
        text-transform: uppercase;
        font-size: 0.9rem;
        transition: all 0.15s ease;
        box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
    }

    #wizardForm input:focus, #wizardForm textarea:focus, #wizardForm select:focus {
        outline: none;
        box-shadow: 6px 6px 0px 0px rgba(79, 70, 229, 1);
        transform: translate(-2px, -2px);
    }

    /* Radio Group Styling */
    .field-wrapper ul {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 1.5rem;
        list-style: none;
        padding: 0;
    }

    .field-wrapper input[type="radio"] { display: none; }

    .field-wrapper label {
        display: block;
        padding: 1.5rem;
        border: 4px solid black;
        font-weight: 900;
        text-transform: uppercase;
        text-align: center;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 4px 4px 0px 0px rgba(0,0,0,1);
        background: white;
    }

    .field-wrapper input[type="radio"]:checked + label {
        background: #4f46e5;
        color: white;
        box-shadow: 0px 0px 0px 0px rgba(0,0,0,1);
        transform: translate(4px, 4px);
    }

    /* File Input */
    input[type="file"] {
        width: 100%;
        border: 4px dashed black;
        padding: 2rem;
        background: #f8fafc;
        font-weight: 900;
        text-transform: uppercase;
        cursor: pointer;
    }

    .transmitting {
        animation: glitch 0.2s infinite;
        opacity: 0.8;
        pointer-events: none;
    }

    @keyframes glitch {
        0% { transform: translate(0); }
        20% { transform: translate(-2px, 2px); }
        40% { transform: translate(-2px, -2px); }
        60% { transform: translate(2px, 2px); }
        80% { transform: translate(2px, -2px); }
        100% { transform: translate(0); }
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('wizardForm');
        const submitBtn = document.getElementById('submitBtn');
        const previewContainer = document.getElementById('preview-container');
        
        // Data Mapping (No longer prefixed with 0- or 1- if using standard Django forms in step logic)
        const fieldMap = {
            'id_item_type': 'prev-badge', 
            'id_title': 'prev-title',
            'id_description': 'prev-desc',
            'id_location': 'prev-loc',
            'id_date_happened': 'prev-date'
        };

        const updatePreview = (id, value) => {
            const previewId = fieldMap[id];
            if (!previewId) return;

            const element = document.getElementById(previewId);
            
            if (id === 'id_item_type') {
                element.textContent = value;
                element.style.backgroundColor = value === 'LOST' ? '#ef4444' : '#10b981';
                element.style.color = 'white';
            } else {
                element.textContent = value || (previewId === 'prev-title' ? 'Untitled_Item' : 'Undefined');
            }
        };

        // Initialize preview with current form data (for Step 2 or validation errors)
        const allInputs = form.querySelectorAll('input, textarea, select');
        allInputs.forEach(input => {
            if(input.type === 'radio' && input.checked) updatePreview(input.name, input.value);
            else if(input.type !== 'radio') updatePreview(input.id, input.value);
        });

        form.addEventListener('input', function(e) {
            updatePreview(e.target.id || e.target.name, e.target.value);
        });

        // Image Handling
        const imageInput = document.querySelector('input[type="file"]');
        if (imageInput) {
            imageInput.addEventListener('change', function() {
                const file = this.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const img = document.getElementById('prev-img');
                        img.src = e.target.result;
                        img.classList.remove('grayscale');
                    }
                    reader.readAsDataURL(file);
                }
            });
        }

        // Finalize Animation
        form.addEventListener('submit', function() {
            submitBtn.innerHTML = '<i class="fa-solid fa-sync fa-spin mr-2"></i> TRANSMITTING...';
            previewContainer.classList.add('transmitting');
        });
    });
</script>
{% endblock %}